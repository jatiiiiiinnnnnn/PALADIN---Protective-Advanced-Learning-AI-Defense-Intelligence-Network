# Master docker-compose.yml for Project PALADIN
# FINAL VERSION: Simplified networking for maximum stability.

volumes:
  shared-log-volume:
  esdata:

services:
  # --- Deception Layer ---
  http-honeypot:
    build: ./low_honeypots
    command: python http.py
    ports: ["8080:8080"]
    volumes: [shared-log-volume:/shared_logs]
  ftp-honeypot:
    build: ./low_honeypots
    command: python ftp.py
    ports: ["2121:2121"]
    volumes: [shared-log-volume:/shared_logs]
  smtp-honeypot:
    build: ./low_honeypots
    command: python smtp.py
    ports: ["2525:2525"]
    volumes: [shared-log-volume:/shared_logs]
  cowrie:
    image: cowrie/cowrie:latest
    ports: ["2222:2222"]
    restart: unless-stopped

  # --- Aggregation Layer ---
  redis:
    image: redis:7-alpine
    container_name: "honeypot-redis"
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  filebeat:
    build: ./log_pipeline/filebeat
    container_name: "honeypot-filebeat"
    depends_on:
      redis: { condition: service_healthy }
    volumes:
      - shared-log-volume:/var/log/honeypots:ro

  consumer:
    build: ./log_pipeline/consumer
    container_name: "honeypot-consumer"
    ports: ["5001:5001"]
    depends_on:
      redis: { condition: service_healthy }
      elasticsearch: { condition: service_healthy }
    volumes:
      - ./log_pipeline/consumer:/app:rw

  # --- Persistence Layer ---
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.6
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock: { soft: -1, hard: -1 }
    volumes:
      - esdata:/usr/share/elasticsearch/data
    ports: ["9200:9200"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 30s    # Check every 30 seconds instead of 10
      timeout: 30s     # Allow 30 seconds for a response
      retries: 10      # Try 10 times before giving up (total ~5 minutes)
      start_period: 60s # Give it a minute of grace period before starting checks

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.6
    container_name: kibana
    ports: ["5601:5601"]
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch