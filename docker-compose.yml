# Final integrated PALADIN Honeypot System

volumes:
  shared-log-volume:
  esdata:

services:
  # --- Low-Interaction Honeypots ---
  http-honeypot:
    build: ./low_honeypots
    command: python http.py
    ports: ["8080:8080"]
    volumes: 
      - shared-log-volume:/shared_logs
    
  ftp-honeypot:
    build: ./low_honeypots
    command: sh -c "python -u ftp.py >> /shared_logs/ftp.log 2>&1"
    ports: ["2121:2121"]
    volumes: 
      - shared-log-volume:/shared_logs
    
  smtp-honeypot:
    build: ./low_honeypots
    command: sh -c "python -u smtp.py >> /shared_logs/smtp.log 2>&1"
    ports: ["2525:2525"]
    volumes: 
      - shared-log-volume:/shared_logs

  log-permissions-fixer:
    image: busybox
    user: root
    volumes:
      - shared-log-volume:/data
    command: sh -c "
      mkdir -p /data/log/cowrie &&
      mkdir -p /data/lib/cowrie/tty &&
      chmod -R 777 /data
      "

  # --- High-Interaction SSH Honeypot (Cowrie) ---
  cowrie:
    image: cowrie/cowrie:latest
    depends_on:
      log-permissions-fixer:
        condition: service_completed_successfully
    ports:
      - "2222:2222"
    volumes:
      - ./high_cowrie/etc/cowrie.cfg:/cowrie/cowrie-git/etc/cowrie.cfg:ro  # Changed path!
      - shared-log-volume:/cowrie/var
    restart: unless-stopped

  # --- Log Aggregation ---
  redis:
    image: redis:7-alpine
    container_name: "honeypot-redis"
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  filebeat:
    build: ./log_pipeline/filebeat
    container_name: "honeypot-filebeat"
    depends_on:
      redis: { condition: service_healthy }
    volumes:
      - shared-log-volume:/shared_logs:ro
      - shared-log-volume:/cowrie_logs:ro  # Mount the same volume at a different path

  # --- AI Consumer ---
  consumer:
    build: ./log_pipeline/consumer
    container_name: "honeypot-consumer"
    command: python -u consumer.py
    depends_on:
      redis: { condition: service_healthy }
      elasticsearch: { condition: service_healthy }
    volumes:
      - ./log_pipeline/consumer:/app:rw

  # --- Data Persistence ---
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock: { soft: -1, hard: -1 }
    volumes:
      - esdata:/usr/share/elasticsearch/data
    ports: ["9200:9200"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 60s
      
  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.6
    container_name: kibana
    ports: ["5601:5601"]
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch